<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <title>Your Cart</title>
    <style>
        /* 기존 스타일 */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            text-align: center;
            padding: 8px;
        }

        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        form {
            display: inline;
        }

        p {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .cart-container {
            margin: 20px auto;
            max-width: 800px;
        }

        .total-amount {
            text-align: right;
        }

        .checkout-btn {
            margin-top: 20px;
            text-align: center;
        }
    </style>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>

<body>
<div layout:fragment="content" class="container cart-container">
    <h1>Your Shopping Cart</h1>

    <table>
        <thead>
        <tr>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="cartItem : ${cartItems}">
            <td th:text="${cartItem.item.name}"></td>
            <td th:text="${cartItem.quantity}"></td>
            <td th:text="${cartItem.item.price}"></td>
            <td th:text="${cartItem.item.price * cartItem.quantity}"></td>
            <td>
                <form th:action="@{/cart/remove}" method="post">
                    <input type="hidden" th:value="${cartItem.item.id}" name="itemId" />
                    <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <p class="total-amount">Total Amount: <span th:text="${totalAmount}"></span></p>

    <div class="checkout-btn">
        <!-- 결제 버튼 클릭 시 requestPay 함수 호출 -->
        <button type="button" onclick="requestPay()">결제하기</button>

    </div>
</div>

<script>
    function requestPay() {
        const IMP = window.IMP; // 생략 가능
        IMP.init('imp22747340'); // 포트원 관리자에서 발급받은 가맹점 식별코드

        IMP.request_pay({
            pg: "html5_inicis", // PG사
            pay_method: "card", // 결제수단
            merchant_uid: "order_" + new Date().getTime(), // 주문 번호
            name: "주문명: 상품명", // 상품명
            amount: 1000, // 결제 금액
            buyer_email: "test@example.com",
            buyer_name: "홍길동",
            buyer_tel: "010-1234-5678",
            buyer_addr: "서울특별시 강남구",
            buyer_postcode: "123-456",
        }, function (rsp) {
            if (rsp.success) {
                // 결제 성공 시 서버로 데이터 전송
                fetch('/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(rsp)
                }).then(response => {
                    if (response.ok) {
                        alert('결제가 완료되었습니다.');
                        window.location.href = "/order/confirmation";
                    } else {
                        alert('결제 정보 저장 중 오류가 발생했습니다.');
                    }
                });
            } else {
                alert('결제가 실패했습니다. 에러 내용: ' + rsp.error_msg);
            }
        });
    }
</script>
<script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

</body>
</html>
